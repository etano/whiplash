#
# Ngxinx configuration file for secure applications.
#
# - Listens on 80 (HTTP) and 443 (HTTPS)
# - Redirects all port 80 traffic to port 443
# - Manages load balancing across Node.js upstream processes.
#

# set search paths for pure Lua external libraries (';;' is the default path):
lua_package_path '/etc/nginx/lua/?.lua;;';
 
# NodeJS instances
upstream whiplashapi {
  least_conn;
  server 127.0.0.1:1337;
}

server {
  # Listen on 80 and 443
  listen 80;
  listen 443 default ssl;
  server_name whiplash.ethz.ch;

  # Settings
  gzip on;
  gzip_min_length 100;
  gzip_buffers 4 32k; # Set the buffer size of gzip, 4 32k is good enough for almost everybody.
  gzip_vary on; # Enables response header of â€œVary: Accept-Encoding
  gzip_types  text/plain application/x-javascript text/xml text/css application/json;
  client_max_body_size 0;

  # Certificate chained with a certificate authority bundle.
  ssl_certificate /etc/nginx/ssl/whiplash.ethz.ch.crt;
  ssl_certificate_key /etc/nginx/ssl/whiplash.ethz.ch.key;
 
  # Redirect all non-SSL traffic to SSL.
  if ($ssl_protocol = "") {
    rewrite ^ https://$host$request_uri? permanent;
  }
 
  # Split off traffic to Node.js backends, and make sure that websockets
  # are managed correctly.
  location / {
    proxy_pass http://whiplashapi;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;
    proxy_read_timeout 3600s;
 
    rewrite_by_lua_file inflate_body.lua;
  }
 
  # Send everything else to a local webroot.
  #root /var/www;
  #index index.html index.htm;
  #location / {
  #  try_files $uri $uri/ index.html;
  #}

  location ~ \.(txt) {
     root /var/www/storage;
  }
}

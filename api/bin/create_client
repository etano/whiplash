var co = require('co');
var libs = process.cwd() + '/libs/';
var log = require(libs + 'log')(module);
var db = require(libs + 'db/mongo');
var pass = require(libs + 'auth/pass');
var token = require(libs + 'auth/oauth2');

var client_id = process.argv[2];
var client_secret = process.argv[3];
var owner_username = process.argv[4];

db.connect(function(err) {
    if(!err) {
        co(function *() {
            var Users = require(libs+'collections/users');
            var user = yield Users.query_one({username: owner_username}, [], {username: "admin"});
            log.info("Found user - %s", user.username);

            var client = {
                name: client_id,
                client_id: client_id,
                client_secret: client_secret // FIXME: client_secret same as password
            };
            var Clients = require(libs+'collections/clients');
            var result = yield Clients.commit_one(client, user);
            log.info("New client - %s:%s", client.client_id, client.client_secret);

            var tokens = yield token.generate_tokens(user, client.client_id);
            log.info("New tokens - %s:%s", tokens.access_token, tokens.refresh_token);

            db.close();
        }).catch(function(err) {
            log.error(err);
            db.close();
        });
    }
});
